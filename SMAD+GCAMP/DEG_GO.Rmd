---
title: "Neurite DEG Analysis, GO and UTR length"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load package, message=FALSE, warning=FALSE}
library(glmnet)
library(readr)
library(clusterProfiler)
library(org.Hs.eg.db)
library(biomaRt)
library(tidyverse)
library(Biostrings)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
ensembl <- useMart("ensembl", dataset="hsapiens_gene_ensembl")
background_genes <- readLines("background_genes.txt")
ensembl <- useEnsembl(
  biomart  = "genes", 
  dataset  = "hsapiens_gene_ensembl",
  mirror   = "useast"        # or "uswest", "asia"
)
```

## Dendrite DEG GO CC (Cellular component) Analysis 

```{r load dendrites deg, message=FALSE, warning=FALSE}
deg_dc <- read_csv("dendrite_cell_DEGs_results.csv")
dendrite_genes_dc <- deg_dc$feature_name[deg_dc$expression_category == "Highly expressed in dendrites"]
cell_genes_dc <- deg_dc$feature_name[deg_dc$expression_category == "Highly expressed in cells"]
cat("Dendrite genes:", length(dendrite_genes_dc),
    "\nCell genes:", length(cell_genes_dc), "\n")
```

```{r annotate dendrites deg, message=FALSE, warning=FALSE}
annotated_genes <- getBM(
  attributes = c("hgnc_symbol", "description", "gene_biotype", "go_id", "name_1006"), 
  filters = "hgnc_symbol",
  values = dendrite_genes_dc, 
  mart = ensembl
)
annotated_genes_grouped <- annotated_genes %>%
  group_by(hgnc_symbol, description, gene_biotype) %>%
  summarise(go_terms = paste(unique(name_1006), collapse="; "), .groups = "drop")
go_results_dc <- enrichGO(
  gene          = dendrite_genes_dc,
  universe      = background_genes,
  keyType       = "SYMBOL",
  OrgDb         = org.Hs.eg.db,
  ont           = "CC",  # Cellular Component 
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.2
)
dotplot(
  go_results_dc,
  showCategory = 10,
  title        = "Top 10 GO Terms, Dendrite CC",
  font.size    = 15
) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

## Axon DEG GO CC (Cellular component) Analysis 
```{r load axon deg, message=FALSE, warning=FALSE}
deg_ac <- read_csv("axon_cell_DEGs_results.csv")
axon_genes_ac <- deg_ac$feature_name[deg_ac$expression_category == "Highly expressed in axons"]
cell_genes_ac <- deg_ac$feature_name[deg_ac$expression_category == "Highly expressed in cells"]
cat("Axon genes:", length(axon_genes_ac),
    "\nCell genes:", length(cell_genes_ac), "\n")
```
```{r annotate axon deg, message=FALSE, warning=FALSE}
annotated_genes <- getBM(
  attributes = c("hgnc_symbol", "description", "gene_biotype", "go_id", "name_1006"), 
  filters = "hgnc_symbol",
  values = axon_genes_ac, 
  mart = ensembl
)
annotated_genes_grouped <- annotated_genes %>%
  group_by(hgnc_symbol, description, gene_biotype) %>%
  summarise(go_terms = paste(unique(name_1006), collapse="; "), .groups = "drop")
go_results_ac <- enrichGO(
  gene          = axon_genes_ac,
  universe      = background_genes,
  keyType       = "SYMBOL",
  OrgDb         = org.Hs.eg.db,
  ont           = "CC",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.4
)
dotplot(
  go_results_ac,
  showCategory = 10,
  title        = "Top 10 GO Terms, Axon CC",
  font.size    = 15
) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```
##Dendrite UTR Analysis 
```{r load dendrites UTR, message=FALSE, warning=FALSE}
all_genes <- unique(c(dendrite_genes_dc, cell_genes_dc))
mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
structure_attrs <- c(
  "ensembl_transcript_id",
  "strand",
  "5_utr_start",
  "5_utr_end",
  "3_utr_start",
  "3_utr_end"
)
structure_data <- getBM(
  attributes = structure_attrs,
  filters    = "hgnc_symbol",
  values     = all_genes,
  mart       = mart
)
feature_attrs <- c(
  "ensembl_transcript_id",
  "hgnc_symbol",
  "transcript_is_canonical"
)
feature_data <- getBM(
  attributes = feature_attrs,
  filters    = "hgnc_symbol",
  values     = all_genes,
  mart       = mart
)
merged_data <- left_join(structure_data, feature_data, by = "ensembl_transcript_id")
merged_data_canonical <- merged_data %>%
  filter(transcript_is_canonical == 1)

summarized_utr <- merged_data_canonical %>%
  mutate(
    partial_5_utr_length = ifelse(
      !is.na(`5_utr_start`) & !is.na(`5_utr_end`),
      abs(`5_utr_end` - `5_utr_start`) + 1,
      0
    ),
    partial_3_utr_length = ifelse(
      !is.na(`3_utr_start`) & !is.na(`3_utr_end`),
      abs(`3_utr_end` - `3_utr_start`) + 1,
      0
    )
  ) %>%
  group_by(ensembl_transcript_id, hgnc_symbol) %>%
  summarize(
    five_utr_length  = sum(partial_5_utr_length),
    three_utr_length = sum(partial_3_utr_length),
    .groups          = "drop"
  )
summarized_utr_labeled <- summarized_utr %>%
  mutate(
    gene_group = case_when(
      hgnc_symbol %in% dendrite_genes_dc ~ "dendrite",
      hgnc_symbol %in% cell_genes_dc     ~ "cell",
      TRUE                               ~ NA_character_
    )
  ) %>%
  filter(!is.na(gene_group))

summarized_utr_labeled_dc <- summarized_utr %>%
  mutate(
    gene_group = case_when(
      hgnc_symbol %in% dendrite_genes_dc ~ "Dendrite",
      hgnc_symbol %in% cell_genes_dc     ~ "Cell body (dendrite)",
      TRUE                               ~ NA_character_
    )
  ) %>%
  filter(!is.na(gene_group))
summarized_utr_labeled %>%
  group_by(gene_group) %>%
  summarize(
    mean_5utr   = mean(five_utr_length, na.rm = TRUE),
    median_5utr = median(five_utr_length, na.rm = TRUE),
    mean_3utr   = mean(three_utr_length, na.rm = TRUE),
    median_3utr = median(three_utr_length, na.rm = TRUE),
    n           = n()
  )
t.test(five_utr_length ~ gene_group, data = summarized_utr_labeled)
t.test(three_utr_length ~ gene_group, data = summarized_utr_labeled)
wilcox.test(five_utr_length ~ gene_group, data = summarized_utr_labeled)
wilcox.test(three_utr_length ~ gene_group, data = summarized_utr_labeled)
summarized_utr_labeled$gene_group <- factor(
  summarized_utr_labeled$gene_group,
  levels = c("dendrite", "cell"),
  labels = c("Dendrite", "Cell")
)

df_long <- summarized_utr_labeled %>%
  select(hgnc_symbol, gene_group, five_utr_length, three_utr_length) %>%
  pivot_longer(
    cols = c(five_utr_length, three_utr_length),
    names_to = "utr_type",
    values_to = "utr_length"
  )

utr_labeller <- as_labeller(c(
  five_utr_length = "5' UTR length",
  three_utr_length = "3' UTR length"
))
```

##Axon UTR Analysis
```{r load axon UTR, message=FALSE, warning=FALSE}
all_genes <- unique(c(axon_genes_ac, cell_genes_ac))
mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
mart <- useEnsembl(
  biomart = "genes",
  dataset = "hsapiens_gene_ensembl",
  mirror  = "useast"
)
structure_attrs <- c(
  "ensembl_transcript_id",
  "strand",
  "5_utr_start",
  "5_utr_end",
  "3_utr_start",
  "3_utr_end"
)
structure_data <- getBM(
  attributes = structure_attrs,
  filters    = "hgnc_symbol",
  values     = all_genes,
  mart       = mart
)
feature_attrs <- c(
  "ensembl_transcript_id",
  "hgnc_symbol",
  "transcript_is_canonical"
)

feature_data <- getBM(
  attributes = feature_attrs,
  filters    = "hgnc_symbol",
  values     = all_genes,
  mart       = mart
)
merged_data <- left_join(structure_data, feature_data, by = "ensembl_transcript_id")
merged_data_canonical <- merged_data %>%
  filter(transcript_is_canonical == 1)

summarized_utr <- merged_data_canonical %>%
  mutate(
    partial_5_utr_length = ifelse(
      !is.na(`5_utr_start`) & !is.na(`5_utr_end`),
      abs(`5_utr_end` - `5_utr_start`) + 1,
      0
    ),
    partial_3_utr_length = ifelse(
      !is.na(`3_utr_start`) & !is.na(`3_utr_end`),
      abs(`3_utr_end` - `3_utr_start`) + 1,
      0
    )
  ) %>%
  group_by(ensembl_transcript_id, hgnc_symbol) %>%
  summarize(
    five_utr_length  = sum(partial_5_utr_length),
    three_utr_length = sum(partial_3_utr_length),
    .groups          = "drop"
  )
summarized_utr_labeled <- summarized_utr %>%
  mutate(
    gene_group = case_when(
      hgnc_symbol %in% axon_genes_ac ~ "axon",
      hgnc_symbol %in% cell_genes_ac     ~ "cell",
      TRUE                               ~ NA_character_
    )
  ) %>%
  filter(!is.na(gene_group))
summarized_utr_labeled_ac <- summarized_utr %>%
  mutate(
    gene_group = case_when(
      hgnc_symbol %in% axon_genes_ac    ~ "Axon",
      hgnc_symbol %in% cell_genes_ac  ~ "Cell body (axon)",
      TRUE                            ~ NA_character_
    )
  ) %>%
  filter(!is.na(gene_group))
summarized_utr_labeled %>%
  group_by(gene_group) %>%
  summarize(
    mean_5utr   = mean(five_utr_length, na.rm = TRUE),
    median_5utr = median(five_utr_length, na.rm = TRUE),
    mean_3utr   = mean(three_utr_length, na.rm = TRUE),
    median_3utr = median(three_utr_length, na.rm = TRUE),
    n           = n()
  )
t.test(five_utr_length ~ gene_group, data = summarized_utr_labeled)
t.test(three_utr_length ~ gene_group, data = summarized_utr_labeled)
wilcox.test(five_utr_length ~ gene_group, data = summarized_utr_labeled)
wilcox.test(three_utr_length ~ gene_group, data = summarized_utr_labeled)
summarized_utr_labeled$gene_group <- factor(
  summarized_utr_labeled$gene_group,
  levels = c("axon", "cell"),
  labels = c("Axon", "Cell")
)
df_long <- summarized_utr_labeled %>%
  select(hgnc_symbol, gene_group, five_utr_length, three_utr_length) %>%
  pivot_longer(
    cols = c(five_utr_length, three_utr_length),
    names_to = "utr_type",
    values_to = "utr_length"
  )

utr_labeller <- as_labeller(c(
  five_utr_length = "5' UTR length",
  three_utr_length = "3' UTR length"
))
ggplot(df_long, aes(x = gene_group, y = utr_length, fill = gene_group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  facet_wrap(~ utr_type, scales = "free", labeller = utr_labeller) +
  labs(
    title = "5′ vs. 3′ UTR Lengths in Axon vs. Cell Genes",
    x = "Gene Group", 
    y = "UTR Length (bp)"
  ) +
  scale_fill_discrete(
    name = "Gene Group",
    labels = c("Axon enriched genes", "Cell body enriched genes")
  ) +
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

##Combined UTR Analysis
```{r load combined UTR, message=FALSE, warning=FALSE}
utr_combined <- bind_rows(
  summarized_utr_labeled_dc,
  summarized_utr_labeled_ac
)
utr_long <- utr_combined %>%
  select(hgnc_symbol, gene_group, five_utr_length, three_utr_length) %>%
  pivot_longer(
    cols      = c(five_utr_length, three_utr_length),
    names_to  = "utr_type",
    values_to = "utr_length"
  ) %>%
  mutate(
    gene_group = factor(
      gene_group,
      levels = c("Axon", "Dendrite",
                 "Cell body (axon)", "Cell body (dendrite)")
    )
  )
utr_labeller <- as_labeller(c(
  five_utr_length  = "5' UTR length",
  three_utr_length = "3' UTR length"
))

pairs <- combn(levels(utr_long$gene_group), 2, simplify = FALSE)
annot <- utr_long %>%
  group_by(utr_type) %>%
  do({
    d     <- .
    max_y <- max(d$utr_length, na.rm = TRUE)
    imap_dfr(pairs, function(pair, i) {
      sub <- filter(d, gene_group %in% pair)
      p   <- wilcox.test(utr_length ~ gene_group, data = sub)$p.value
      tibble(
        utr_type = unique(d$utr_type),
        xstart   = which(levels(d$gene_group) == pair[1]),
        xend     = which(levels(d$gene_group) == pair[2]),
        # pull the bar very close: 1.005 × max_y plus stagger of 0.04
        y        = max_y * 1.005 + (i - 1) * (max_y * 0.04),
        h        = max_y * 0.02,
        label    = case_when(
          p < 0.00005 ~ "****",
          p < 0.0005  ~ "***",
          p < 0.005   ~ "**",
          p < 0.05    ~ "*",
          TRUE        ~ "NS"
        )
      )
    })
  }) %>%
  ungroup()

ggplot(utr_long, aes(x = gene_group, y = utr_length, fill = gene_group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1) +
  facet_wrap(~ utr_type, scales = "free", labeller = utr_labeller) +
  scale_fill_manual(
    name = "Gene Group",
    values = c(
      "Axon"                 = "#e38900",
      "Dendrite"             = "#f8766d",
      "Cell body (axon)"     = "#619cff",
      "Cell body (dendrite)" = "#00bfc4"
    )
  ) +
  labs(
    title = "5' vs. 3' UTR Lengths Across Dendrite, Axon, and Cell Body Gene Groups",
    x     = "Gene Group",
    y     = "UTR Length (bp)"
  ) +
  theme_bw() +
  theme(
    panel.grid.major   = element_blank(),
    panel.grid.minor   = element_blank(),
    axis.text.x        = element_text(angle = 30, hjust = 1),
    legend.position    = "none"
  ) +
  geom_segment(
    data = annot,
    aes(x = xstart, xend = xend, y = y, yend = y),
    inherit.aes = FALSE,
    size = 0.5
  ) +
  geom_segment(
    data = annot,
    aes(x = xstart, xend = xstart, y = y, yend = y - h),
    inherit.aes = FALSE,
    size = 0.5
  ) +
  geom_segment(
    data = annot,
    aes(x = xend, xend = xend, y = y, yend = y - h),
    inherit.aes = FALSE,
    size = 0.5
  ) +
  geom_text(
  data = filter(annot, label != "NS"),
  aes(x = (xstart + xend) / 2, y = y, label = label),
  inherit.aes = FALSE,
  size  = 7.5,
  vjust = 0.57
  ) +
  geom_text(
    data = filter(annot, label == "NS"),
    aes(x = (xstart + xend) / 2, y = y, label = label),
    inherit.aes = FALSE,
    size  = 3,      # or whatever smaller size you like
    vjust = -0.3,
    color = "black"
  )
```
